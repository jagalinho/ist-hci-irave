const calendar = [
    {   //DAY 1
        'date': new Date(2017, 7, 18),
        'stages': {
            'North Stage': [
                {'artist': "Khalid", 'start': new Date(2018, 7, 18, 18, 05), 'end': new Date(2018, 7, 18, 20, 55)},
                {'artist': "Snow Patrol", 'start': new Date(2018, 7, 18, 21, 05), 'end': new Date(2018, 7, 18, 22, 35)},
                {'artist': "James Arthur", 'start': new Date(2018, 7, 18, 22, 35), 'end': new Date(2018, 7, 18, 23, 35)},
                {'artist': "Kaleo", 'start': new Date(2018, 7, 18, 23, 55), 'end': new Date(2018, 7, 19, 00, 55)}
            ],
            'South Stage': [
                {'artist': "NF", 'start': new Date(2018, 7, 18, 23, 05), 'end': new Date(2018, 7, 18, 23, 20)},
                {'artist': "Eminem", 'start': new Date(2018, 7, 18, 23, 35), 'end': new Date(2018, 7, 18, 23, 55)},
                {'artist': "Wolf Alice", 'start': new Date(2018, 7, 19, 00, 05), 'end': new Date(2018, 7, 19, 00, 55)},
                {'artist': "Sampha", 'start': new Date(2018, 7, 19, 00, 55), 'end': new Date(2018, 7, 11, 1, 55)}
            ],
            'Special Stage': [
                {'artist': "António Zambujo", 'start': new Date(2018, 7, 18, 23, 05), 'end': new Date(2018, 7, 18, 23, 20)},
                {'artist': "Pedro Seabra", 'start': new Date(2018, 7, 18, 23, 35), 'end': new Date(2018, 7, 18, 23, 55)},
                {'artist': "Queens of the Stone Age", 'start': new Date(2018, 7, 18, 00, 05), 'end': new Date(2018, 7, 19, 00, 55)},
                {'artist': "The National", 'start': new Date(2018, 7, 19, 00, 55), 'end': new Date(2018, 7, 19, 1, 55)}
            ]
        }
    },
    {   //DAY 2
        'date': new Date(2018, 7, 19),
        'stages': {
            'North Stage': [
            	{'artist': "3 Doors Down", 'start': new Date(2018, 7, 19, 23, 05), 'end': new Date(2018, 7, 19, 23, 20)},
                {'artist': "Robbie Williams", 'start': new Date(2018, 7, 19, 23, 35), 'end': new Date(2018, 7, 19, 23, 55)},
                {'artist': "Rag ‘N’ Bone Man", 'start': new Date(2018, 7, 19, 00, 05), 'end': new Date(2018, 7, 20, 00, 55)},
                {'artist': "Enrique Iglesias", 'start': new Date(2018, 7, 20, 00, 55), 'end': new Date(2018, 7, 20, 1, 55)}

            ],
            'South Stage': [
                {'artist': "Fingertips", 'start': new Date(2018, 7, 19, 23, 05), 'end': new Date(2018, 7, 19, 23, 20)},
                {'artist': "Colbie Caillat", 'start': new Date(2018, 7, 19, 23, 35), 'end': new Date(2018, 7, 19, 23, 35)},
             	{'artist': "David Guetta", 'start': new Date(2018, 7, 19, 00, 05), 'end': new Date(2018, 7, 20, 00, 55)},
                {'artist': "Rita Ora", 'start': new Date(2018, 7, 20, 00, 55), 'end': new Date(2018, 7, 20, 1, 55)}
            ],
            'Special Stage': [
                {'artist': "Avicii", 'start': new Date(2018, 7, 19, 23, 05), 'end': new Date(2018, 7, 19, 23, 20)},
                {'artist': "Kygo", 'start': new Date(2018, 7, 19, 23, 35), 'end': new Date(2018, 7, 19, 23, 35)},
             	{'artist': "U2", 'start': new Date(2018, 7, 19, 00, 05), 'end': new Date(2018, 7, 20, 00, 55)},
                {'artist': "Coldplay", 'start': new Date(2018, 7, 20, 00, 55), 'end': new Date(2018, 7, 20, 1, 55)}
            ]
        }
    },
     {   //DAY 3
        'date': new Date(2018, 7, 20),
        'stages': {
            'North Stage': [
            	{'artist': "Bob Marley", 'start': new Date(2018, 7, 20, 23, 05), 'end': new Date(2018, 7, 20, 23, 20)},
                {'artist': "The weekend", 'start': new Date(2018, 7, 20, 23, 35), 'end': new Date(2018, 7, 20, 23, 55)},
                {'artist': "Post Malone", 'start': new Date(2018, 7, 20, 00, 05), 'end': new Date(2018, 7, 21, 00, 55)},
                {'artist': "Dua Lipa", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 1, 55)}
            ],
            'South Stage': [
                {'artist': "Don Diablo", 'start': new Date(2018, 7, 20, 23, 05), 'end': new Date(2018, 7, 20, 23, 20)},
                {'artist': "Shawn Mandes", 'start': new Date(2018, 7, 20, 23, 35), 'end': new Date(2018, 7, 20, 23, 55)},
                {'artist': "Charlie puth", 'start': new Date(2018, 7, 20, 00, 05), 'end': new Date(2018, 7, 21, 00, 55)},
                {'artist': "Camila Cabello", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 1, 55)}
            ],
            'Special Stage': [
                {'artist': "Ariana Grande", 'start': new Date(2018, 7, 20, 23, 05), 'end': new Date(2018, 7, 20, 23, 20)},
                {'artist': "bruno Mars", 'start': new Date(2018, 7, 20, 23, 35), 'end': new Date(2018, 7, 20, 23, 55)},
                {'artist': "Calvin Harris", 'start': new Date(2018, 7, 20, 00, 05), 'end': new Date(2018, 7, 21, 00, 55)},
                {'artist': "Justin Timberlake", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 1, 55)}
            ]
        }
    },
    {   //DAY 4
        'date': new Date(2018, 7, 21),
        'stages': {
            'North Stage': [
            	{'artist': "Jessie J", 'start': new Date(2018, 7, 21, 23, 05), 'end': new Date(2018, 7, 21, 23, 20)},
                {'artist': "Ed Sheeran", 'start': new Date(2018, 7, 21, 23, 35), 'end': new Date(2018, 7, 21, 23, 55)},
                {'artist': "Iggy Azelea", 'start': new Date(2018, 7, 21, 00, 05), 'end': new Date(2018, 7, 22, 00, 55)},
                {'artist': "Christina Perri", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 2, 55)}
            ],
            'South Stage': [
            	{'artist': "Miguel Araújo", 'start':  new Date(2018, 7, 21, 23, 05), 'end': new Date(2018, 7, 21, 23, 20)},
            	{'artist': "Two Door Cinema Club", 'start': new Date(2018, 7, 21, 23, 35), 'end': new Date(2018, 7, 21, 23, 55)},
            	{'artist': "Pearl Jam", 'start': new Date(2018, 7, 21, 00, 05), 'end': new Date(2018, 7, 22, 00, 55)},
            	{'artist': "Taylor Swift", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 2, 55)}
            ],
            'Special Stage': [
                {'artist': "Imagine Dragons", 'start':  new Date(2018, 7, 21, 23, 05), 'end': new Date(2018, 7, 21, 23, 20)},
                {'artist': "One Republic", 'start': new Date(2018, 7, 21, 23, 35), 'end': new Date(2018, 7, 21, 23, 55)},
                {'artist': "Pink", 'start': new Date(2018, 7, 21, 00, 05), 'end': new Date(2018, 7, 22, 00, 55)},
                {'artist': "Drake", 'start': new Date(2018, 7, 21, 00, 55), 'end': new Date(2018, 7, 21, 2, 55)}
            ]
        }
    },
];

const places = {
    'bars': [
        {'name': "No Bar", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 90, 'distance': 500}},
        {'name': "In Time", 'open': false, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 135, 'distance': 1000}},
        {'name': "Everthing", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 30, 'distance': 2500}},
        {'name': "Sagres", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 10, 'distance': 500}},
        {'name': "Rust Bar", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction':270, 'distance': 1200}}
    ],
    'wc': [
        {'name': "WC Special Stage", 'open': true, 'ticketable': false, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 180, 'distance': 1500}},
        {'name': "WC South Stage", 'open': true, 'ticketable': false, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 225, 'distance': 2000}},
    	{'name': "WC North Stage", 'open': true, 'ticketable': false, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 100, 'distance': 100}},
		{'name': "WC Tents", 'open': true, 'ticketable': false, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 225, 'distance': 20}},
		{'name': "WC Activities", 'open': true, 'ticketable': false, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 300, 'distance': 3000}}
    ],
    'stages': [
        {'name': "North Stage", 'open': false, 'ticketable': false, 'waitTime': false, 'location': {'direction': 0, 'distance': 2750}},
        {'name': "South Stage", 'open': true, 'ticketable': false, 'waitTime': false, 'location': {'direction': 45, 'distance': 30}},
        {'name': "Special Stage", 'open': true, 'ticketable': false, 'waitTime': false, 'location': {'direction': 100, 'distance': 1000}}
    ],
    'activities': [
        {'name': "Montanha Russa", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 270, 'distance': 600}},
        {'name': "Tiro ao arco", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 315, 'distance': 980}},
        {'name': "Roda Gigante", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 150, 'distance': 580}},
        {'name': "Rapel", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 100, 'distance': 80}},
        {'name': "Escalada", 'open': true, 'ticketable': true, 'waitTime': Math.floor(Math.random() * 50*60000), 'location': {'direction': 15, 'distance': 900}}
    ]
}

const friendGenerator = [
    {'name': "Francisco", 'present': true, 'location': {'place': "North Stage", 'direction': 0, 'distance': 2750}},
    {'name': "Diogo Vieira", 'present': true, 'location': {'place': "WC Tents", 'direction': 225, 'distance': 20}},
    {'name': "Tomás", 'present': true, 'location': {'place': "Sagres", 'direction': 10, 'distance': 500}},
    {'name': "Catarina", 'present': true, 'location': {'place': "South Stage", 'direction': 45, 'distance': 30}},
    {'name': "Diogo Valente", 'present': true, 'location': {'place': "Rust Bar", 'direction': 270, 'distance': 1200}},
    {'name': "João", 'present': true, 'location': {'place': "Rapel", 'direction': 100, 'distance': 80}},
    {'name': "André Barão", 'present': true, 'location': false},
    {'name': "Ricardo", 'present': false, 'location': false},
    {'name': "Filipe", 'present': true, 'location': false},
    {'name': "Mara", 'present': true, 'location': false},
    {'name': "Gonçalo", 'present': false, 'location': false},
    {'name': "Vitor", 'present': false, 'location': false}
];

//HOMESCREEN

function currentTime() {
    let today = new Date();
    document.getElementById('time').innerHTML = (today.getHours()<10 ? '0'+today.getHours() : today.getHours()) + ':' + (today.getMinutes()<10 ? '0'+today.getMinutes() : today.getMinutes());
    document.getElementById('date').innerHTML = today.toLocaleDateString();
    document.getElementById('time-lock').innerHTML = (today.getHours()<10 ? '0'+today.getHours() : today.getHours()) + ':' + (today.getMinutes()<10 ? '0'+today.getMinutes() : today.getMinutes());
    document.getElementById('date-lock').innerHTML = today.toLocaleDateString();
    setTimeout('currentTime()', 1000);
}

//LOCATION TOGGLE

var toggleState = true;
var toggleTimer;

function toggleLocation() {
    if (toggleState) {
        document.getElementById('location-button').classList.remove('active');
        document.getElementById('location-button').classList.add('inactive');
        document.getElementById('phrase').innerHTML = "Location <br> OFF";
        document.getElementById('notification').style.display = 'grid';
        document.getElementById('notification-phrase').style.display = 'grid';
        clearTimeout(toggleTimer);
        toggleTimer = setTimeout(() => {
            document.getElementById('notification').style.display = 'none';
            document.getElementById('notification-phrase').style.display = 'none';
        }, 600);
        toggleState = false;
    } else {
        document.getElementById('location-button').classList.remove('inactive');
        document.getElementById('location-button').classList.add('active');
        document.getElementById('phrase').innerHTML = "Location <br> ON";
        document.getElementById('notification').style.display = 'grid';
        document.getElementById('notification-phrase').style.display = 'grid';
        clearTimeout(toggleTimer);
        toggleTimer = setTimeout(() => {
            document.getElementById('notification').style.display = 'none';
            document.getElementById('notification-phrase').style.display = 'none';
        }, 600);
        toggleState = true;
    }
}

//SCREEN LOGIC

var screenHistory = ['home'];
var locked = true;

function changeScreen(newScreen) {
    document.getElementById(screenHistory[screenHistory.length - 1]).style.display = 'none';
    document.getElementById(newScreen).style.display = 'grid';
    screenHistory.push(newScreen);
}

function changeScreenBack() {
    document.getElementById(screenHistory.pop()).style.display = 'none';
    if (screenHistory[screenHistory.length - 1] == 'shows')
        loadShows();
    document.getElementById(screenHistory[screenHistory.length - 1]).style.display = 'grid';
}

function removeScreenHistory(screensToRemove) {
    screenHistory = screenHistory.filter((screen) => !screensToRemove.includes(screen))
}

function lockButton() {
    if (locked) {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById(screenHistory[screenHistory.length - 1]).style.display = 'grid';
        locked = false;
    } else {
        document.getElementById('lockScreen').style.display = 'grid';
        document.getElementById(screenHistory[screenHistory.length - 1]).style.display = 'none';
        locked = true;
    }
}

function homeButton() {
    if (locked) {
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById(screenHistory[screenHistory.length - 1]).style.display = 'grid';
        locked = false;
    } else {
        changeScreen('home');
        screenHistory = ['home'];
    }
}

//CALENDAR

var calendarFavorites = [];
var currDay, currStage;

function loadCalendar() {
    let listDays = document.createElement('div');
    listDays.id = 'listDays';
    listDays.className = 'vertical-menu';

    calendar.sort(function(a, b) {return a.date - b.date}).forEach(({date, stages}, i) => {
        let passed = true;
        let today = new Date();
        Object.keys(stages).forEach((stage) => {
            stages[stage].sort(function(a, b) {return a.start - b.start}).forEach(({end}) => {
                if (end > today)
                    passed = false;
            });
        });
        let item = document.createElement('a');
        item.className = 'item';
        if (passed)
            item.classList.add('passed');
        let itemDay = document.createElement('div');
        itemDay.id = 'calendar-day';
        itemDay.innerHTML = 'Day ' + (i+1);
        item.appendChild(itemDay);
        let itemDate = document.createElement('div');
        itemDate.id = 'calendar-date';
        itemDate.innerHTML = date.toLocaleDateString('en', {day: 'numeric', month: 'long'});
        item.appendChild(itemDate);
        item.onclick = () => {
            currDay = i;
            loadStages();
            document.getElementById('stages-title').innerHTML = 'Day ' + (currDay+1);
            changeScreen('stages');
        }
        listDays.appendChild(item);
    });

    if (document.contains(document.getElementById('listDays')))
        document.getElementById('calendar').removeChild(document.getElementById('listDays'));
    document.getElementById('calendar').appendChild(listDays);
}

function loadStages() {
    let listStages = document.createElement('div');
    listStages.id = 'listStages';
    listStages.className = 'vertical-menu';

    Object.keys(calendar[currDay].stages).forEach((stage) => {
        let passed = true;
        let today = new Date();
        calendar[currDay].stages[stage].forEach(({end}) => {
            if (end > today)
                passed = false;
        });
        let item = document.createElement('a');
        item.className = 'item';
        if (passed)
            item.classList.add('passed');
        item.innerHTML = stage;
        item.onclick = () => {
            currStage = item.innerHTML;
            loadShows();
            changeScreen('shows');
        }
        listStages.appendChild(item);
    });

    if (document.contains(document.getElementById('listStages')))
        document.getElementById('stages').removeChild(document.getElementById('listStages'));
    document.getElementById('stages').appendChild(listStages);
}

function generateShow(artist, start, end, day, stage, favorite) {
    let item = document.createElement('div');
    item.className = 'item';
    if (end < new Date())
        item.classList.add('passed');

    let icon = document.createElement('i');
    icon.className = 'favorites fas fa-star';
    if (calendarFavorites.includes(artist))
        icon.classList.add('selected');
    icon.onclick = () => {
        if (calendarFavorites.includes(artist)) {
            icon.classList.remove('selected');
            calendarFavorites.splice(calendarFavorites.indexOf(artist), 1);
        } else {
            icon.classList.add('selected');
            calendarFavorites.push(artist);
        }
    };
    item.appendChild(icon);

    let artistName = document.createElement('div');
    artistName.className = 'artist';
    artistName.innerHTML = artist;
    item.appendChild(artistName);

    let infoDiv = document.createElement('div');
    infoDiv.id = 'info'+artist+favorite;
    infoDiv.className = 'info';
    infoDiv.innerHTML = (start.getHours()<10 ? '0'+start.getHours() : start.getHours()) + ':' + (start.getMinutes()<10 ? '0'+start.getMinutes() : start.getMinutes());
    item.appendChild(infoDiv);

    let toggle = document.createElement('div');
    toggle.className = 'toggle';
    let info = 'hours';
    toggle.onclick = () => {
        if (info === 'hours') {
            document.getElementById('info'+artist+favorite).innerHTML = calendar[day].date.toLocaleDateString('en', {day: 'numeric', month: 'long'});
            info = 'date';
        } else if (info === 'date') {
            document.getElementById('info'+artist+favorite).innerHTML = stage;
            info = 'stage';
        } else {
            document.getElementById('info'+artist+favorite).innerHTML = (start.getHours()<10 ? '0'+start.getHours() : start.getHours()) + ':' + (start.getMinutes()<10 ? '0'+start.getMinutes() : start.getMinutes());
            info = 'hours';
        }
    };
    item.appendChild(toggle);
    
    return item;
}

function loadShows() {
    let listShows = document.createElement('div');
    listShows.id = 'listShows';
    listShows.className = 'vertical-menu';

    calendar[currDay].stages[currStage].forEach(({artist, start, end}) =>
        listShows.appendChild(generateShow(artist, start, end, currDay, currStage, 0))
    );

    if (document.contains(document.getElementById('listShows')))
        document.getElementById('shows').removeChild(document.getElementById('listShows'));
    document.getElementById('shows').appendChild(listShows);

    document.getElementById('shows-title').innerHTML = 'Day ' + (currDay+1) + ': ' + currStage;
    if (document.getElementById('shows-title').innerHTML.length > 13)
        document.getElementById('shows-title').classList.add('slide');
    else
        document.getElementById('shows-title').classList.remove('slide');
}

function loadCalendarFavorites() {
    if (document.contains(document.getElementById('listCalendarFavorites')))
        document.getElementById('calendar-favorites').removeChild(document.getElementById('listCalendarFavorites'));
    if (calendarFavorites.length === 0) {
        document.getElementById('empty-calendar-favorites').style.display = 'inline';
    } else {
        document.getElementById('empty-calendar-favorites').style.display = 'none';
        let listFavorites = document.createElement('div');
        listFavorites.id = 'listCalendarFavorites';
        listFavorites.className = 'vertical-menu';

        let arrayFavorites = [];
        calendar.forEach(({stages}, day) => {
            Object.keys(stages).forEach((stage) => {
                stages[stage].forEach(({artist, start, end}) => {
                    if (calendarFavorites.includes(artist))
                        arrayFavorites.push({artist, start, end, day, stage});
                })
            })
        });
        arrayFavorites.sort(function(a, b) {return a.start - b.start}).forEach(({artist, start, end, day, stage}) => {
            listFavorites.appendChild(generateShow(artist, start, end, day, stage, 1));
        });

        document.getElementById('calendar-favorites').appendChild(listFavorites);
    }
}

//FRIENDS

var friendsList = [];
var friendsFavorites = [];
var currFriend;
var friendTimeout;

function askAddFriend() {
    clearTimeout(friendTimeout);
    if (friendGenerator.length > 0)
        friendTimeout = setTimeout(() => {
            currFriend = friendGenerator[Math.floor(Math.random() * friendGenerator.length)];
            document.getElementById('friend-to-add').innerHTML = currFriend.name;
            changeScreen('add-friend-confirmation');
        }, 5000);
}

function addFriend() {
    friendsList.push(currFriend);
    friendGenerator.splice(friendGenerator.indexOf(currFriend), 1);
}

function removeFriend() {
    friendsList.splice(friendsList.indexOf(currFriend), 1);
    if (friendsFavorites.indexOf(currFriend.name) > -1)
        friendsFavorites.splice(friendsFavorites.indexOf(currFriend.name), 1);
    friendGenerator.push(currFriend);
}

function loadFriends() {
    let listFriends = document.createElement('div');
    listFriends.id = 'listFriends';
    listFriends.className = 'vertical-menu';

    friendsList.sort(function(a, b) {
        if (a.present && !b.present)
            return -1;
        else if (!a.present && b.present)
            return 1;
        return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});
    }).forEach((friend) => {
        listFriends.appendChild(generateFriend(friend));
    });
    
    let addFriend = document.createElement('a');
    addFriend.id = "addFriend";
    addFriend.className = 'item';
    let addFriendIcon = document.createElement('i');
    addFriendIcon.className = 'fas fa-user-plus';
    addFriendIcon.onclick = () => {
        changeScreen('add-friend-nfc');
        askAddFriend();
    };
    addFriend.appendChild(addFriendIcon);
    listFriends.appendChild(addFriend);

    if (document.contains(document.getElementById('listFriends')))
        document.getElementById('friends').removeChild(document.getElementById('listFriends'));
    document.getElementById('friends').appendChild(listFriends);
}

function loadFriendFavorites() {
    if (document.contains(document.getElementById('listFriendsFavorites')))
        document.getElementById('friends-favorites').removeChild(document.getElementById('listFriendsFavorites'));
    if (friendsFavorites.length === 0) {
        document.getElementById('empty-friends-favorites').style.display = 'inline';
    } else {
        document.getElementById('empty-friends-favorites').style.display = 'none';
        let listFavorites = document.createElement('div');
        listFavorites.id = 'listFriendsFavorites';
        listFavorites.className = 'vertical-menu';

        let arrayFavorites = [];
        friendsList.forEach((friend) => {
            if (friendsFavorites.includes(friend.name))
                arrayFavorites.push(friend);
        });
        arrayFavorites.sort(function(a, b) {
            if (a.present && !b.present)
                return -1;
            else if (!a.present && b.present)
                return 1;
            return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});
        }).forEach((friend) => {
            listFavorites.appendChild(generateFriend(friend));
        });

        document.getElementById('friends-favorites').appendChild(listFavorites);
    }
}

function generateFriend(friend) {
    let item = document.createElement('div');
    item.className = 'item';
    if (!friend.present)
        item.classList.add('passed');

    let icon = document.createElement('i');
    icon.className = 'favorites fas fa-star';
    if (friendsFavorites.includes(friend.name))
        icon.classList.add('selected');
    icon.onclick = () => {
        if (friendsFavorites.includes(friend.name)) {
            icon.classList.remove('selected');
            friendsFavorites.splice(friendsFavorites.indexOf(friend.name), 1);
        } else {
            icon.classList.add('selected');
            friendsFavorites.push(friend.name);
        }
    };
    item.appendChild(icon);

    let name = document.createElement('div');
    name.className = 'artist';
    name.innerHTML = friend.name;
    item.appendChild(name);

    let location = document.createElement('div');
    location.id = 'location';
    location.className = 'info';
    friend.location ? location.innerHTML = friend.location.place : (friend.present ? location.innerHTML = "[Not Locatable]" : location.innerHTML = "[Not Present]");
    item.appendChild(location);

    let click = document.createElement('div');
    click.className = 'toggle';
    click.onclick = () => {
        loadFriendScreen(friend);
        changeScreen('friend');
    };
    item.appendChild(click);
    
    return item;
}

function loadFriendScreen(friend) {
    if (friend.location) {
        document.getElementById('arrow').classList.remove('disabled');
        document.getElementById('arrow').style.transform = "rotate(" + (friend.location.direction-45) + "deg)";
        if (friend.location.distance < 1000)
            document.getElementById('friend-distance').innerHTML = friend.location.distance + 'm';
        else
            document.getElementById('friend-distance').innerHTML = (friend.location.distance/1000).toFixed(2) + 'km';
        document.getElementById('friend-location').innerHTML = friend.location.place
    } else {
        document.getElementById('arrow').classList.add('disabled');
        friend.present ? document.getElementById('friend-location').innerHTML = "Not Locatable" : document.getElementById('friend-location').innerHTML = "Not Present";
        document.getElementById('friend-distance').innerHTML = '';
    }

    document.getElementById('friend-title').innerHTML = friend.name;
    if (document.getElementById('friend-title').innerHTML.length > 13)
        document.getElementById('friend-title').classList.add('slide');
    else
        document.getElementById('friend-title').classList.remove('slide');
    
    document.getElementById('friend-to-remove').innerHTML = friend.name;
    currFriend = friend;
}

//PLACES

var placesFavorites = [];
var tickets = [];
var currPlace;
var currPlaceType;
var currTicket;

function loadPlaces() {
    let listBars = document.createElement('div');
    listBars.id = 'listBars';
    listBars.className = 'vertical-menu';
    places.bars.sort(function (a, b) {return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});}).forEach((bar) => {
        listBars.appendChild(generatePlace(bar, 'bars'));
    });
    if (document.contains(document.getElementById('listBars')))
        document.getElementById('bars').removeChild(document.getElementById('listBars'));
    document.getElementById('bars').appendChild(listBars);

    let listWC = document.createElement('div');
    listWC.id = 'listWC';
    listWC.className = 'vertical-menu';
    places.wc.sort(function (a, b) {return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});}).forEach((wc) => {
        listWC.appendChild(generatePlace(wc, 'wc'));
    });
    if (document.contains(document.getElementById('listWC')))
        document.getElementById('wc').removeChild(document.getElementById('listWC'));
    document.getElementById('wc').appendChild(listWC);

    let listStages = document.createElement('div');
    listStages.id = 'listPlaceStages';
    listStages.className = 'vertical-menu';
    places.stages.sort(function (a, b) {return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});}).forEach((stage) => {
        listStages.appendChild(generatePlace(stage, 'stages'));
    });
    if (document.contains(document.getElementById('listPlaceStages')))
        document.getElementById('place-stages').removeChild(document.getElementById('listPlaceStages'));
    document.getElementById('place-stages').appendChild(listStages);

    let listActivities = document.createElement('div');
    listActivities.id = 'listOthers';
    listActivities.className = 'vertical-menu';
    places.activities.sort(function (a, b) {return a.name.localeCompare(b.name, 'en', {sensitivity: 'base'});}).forEach((activity) => {
        listActivities.appendChild(generatePlace(activity, 'activities'));
    });
    if (document.contains(document.getElementById('listOthers')))
        document.getElementById('others').removeChild(document.getElementById('listOthers'));
    document.getElementById('others').appendChild(listActivities);
}

function loadPlacesFavorites() {
    if (document.contains(document.getElementById('listPlacesFavorites')))
        document.getElementById('places-favorites').removeChild(document.getElementById('listPlacesFavorites'));
    if (placesFavorites.length === 0) {
        document.getElementById('empty-places-favorites').style.display = 'inline';
    } else {
        document.getElementById('empty-places-favorites').style.display = 'none';
        let listFavorites = document.createElement('div');
        listFavorites.id = 'listPlacesFavorites';
        listFavorites.className = 'vertical-menu';

        let arrayFavorites = [];
        Object.keys(places).forEach((type) => {
            places[type].forEach((place) => {
                if (placesFavorites.includes(place.name))
                    arrayFavorites.push([place, type]);
            });
        });
        arrayFavorites.sort(function (a, b) {
            if (a[1] != a[2])
                return Object.keys(places).indexOf(a[1]) - Object.keys(places).indexOf(b[1]);
            return a[0].name.localeCompare(b[0].name, 'en', {sensitivity: 'base'});
        }).forEach((place) => {
            listFavorites.appendChild(generatePlace(place[0], place[1]));
        });

        document.getElementById('places-favorites').appendChild(listFavorites);
    }
}

function generatePlace(place, type) {
    let item = document.createElement('div');
    item.className = 'item';
    if (!place.open)
        item.classList.add('passed');

    let icon = document.createElement('i');
    icon.className = 'favorites fas fa-star';
    if (placesFavorites.includes(place.name))
        icon.classList.add('selected');
    icon.onclick = () => {
        if (placesFavorites.includes(place.name)) {
            icon.classList.remove('selected');
            placesFavorites.splice(placesFavorites.indexOf(place.name), 1);
        } else {
            icon.classList.add('selected');
            placesFavorites.push(place.name);
        }
    };
    item.appendChild(icon);

    let name = document.createElement('div');
    name.className = 'artist';
    name.innerHTML = place.name;
    item.appendChild(name);

    let waitTime = document.createElement('div');
    waitTime.id = 'wait-time';
    waitTime.className = 'info';
    if (place.open) {
        if (place.waitTime)
            waitTime.innerHTML = {'bars': "Bar", 'wc': "WC", 'stages': "Stage", 'activities': "Activity"}[type] + " | " + ("0" + Math.floor(place.waitTime/60000)).slice(-2) + ":" + ("0" + Math.round((place.waitTime%60000)/1000)).slice(-2);
        else
            waitTime.innerHTML = {'bars': "Bar", 'wc': "WC", 'stages': "Stage", 'activities': "Activity"}[type];
    } else {
        waitTime.innerHTML = {'bars': "Bar", 'wc': "WC", 'stages': "Stage", 'activities': "Activity"}[type] + " | Closed";
    }
    item.appendChild(waitTime);

    let click = document.createElement('div');
    click.className = 'toggle';
    click.onclick = () => {
        loadPlaceScreen(place, type);
        changeScreen('place');
    };
    item.appendChild(click);
    
    return item;
}

function loadPlaceScreen(place, type) {
    if (place.location.distance < 1000)
        document.getElementById('place-distance').innerHTML = place.location.distance + 'm';
    else
        document.getElementById('place-distance').innerHTML = (place.location.distance/1000).toFixed(2) + 'km';

    if (place.ticketable && place.open)
        document.getElementById('ticket-button').style.display = 'grid';
    else
        document.getElementById('ticket-button').style.display = 'none';

    if (!place.open) {
        document.getElementById('place-ewt').innerHTML = "Closed";
    } else if (place.waitTime) {
        document.getElementById('place-ewt').innerHTML = "Wait Time: " + ("0" + Math.floor(place.waitTime/60000)).slice(-2) + ":" + ("0" + Math.round((place.waitTime%60000)/1000)).slice(-2);
        document.getElementById('place-ewt').style.display = 'grid';
    } else {
        document.getElementById('place-ewt').style.display = 'none';
    }

    document.getElementById('place-arrow').style.transform = "rotate(" + (place.location.direction-45) + "deg)";

    document.getElementById('place-title').innerHTML = {'bars': "Bar", 'wc': "WC", 'stages': "Stage", 'activities': "Activity"}[type] + ": " + place.name;
    if (document.getElementById('place-title').innerHTML.length > 14)
        document.getElementById('place-title').classList.add('slide');
    else
        document.getElementById('place-title').classList.remove('slide');
    
    if (tickets.some(t => t.name === place.name))
        document.getElementById('ticket-button').onclick = () => {
            loadTicketScreen(tickets.filter(t => t.name === place.name)[0]);
            changeScreen('ticket');
        };
    else {
        document.getElementById('ticket-button').onclick = () => {
            document.getElementById('place-to-ticket').innerHTML = place.name;
            changeScreen('ticket-confirmation');
        };
    }
    
    currPlace = place;
    currPlaceType = type;
}

function takeTicket() {
    let ticketNum = Math.floor(Math.random() * 19) + 1;
    tickets.push({'name': currPlace.name, 'type': currPlaceType, 'number': ticketNum, 'estimatedTime': ((ticketNum-1) * 60000) + Math.floor(Math.random() * 2*60000)});
    loadPlaceScreen(currPlace, currPlaceType);
}

function loadTickets() {
    if (document.contains(document.getElementById('listTickets')))
        document.getElementById('myTickets').removeChild(document.getElementById('listTickets'));
    if (tickets.length === 0) {
        document.getElementById('empty-places-tickets').style.display = 'inline';
    } else {
        document.getElementById('empty-places-tickets').style.display = 'none';
        let listTickets = document.createElement('div');
        listTickets.id = 'listTickets';
        listTickets.className = 'vertical-menu';
        tickets.sort(function (a, b) {return a.estimatedTime - b.estimatedTime;}).forEach((ticket) => {
            listTickets.appendChild(generateTicket(ticket));
        });
        if (document.contains(document.getElementById('listTickets')))
            document.getElementById('myTickets').removeChild(document.getElementById('listTickets'));
        document.getElementById('myTickets').appendChild(listTickets);
    }
}

function generateTicket(ticket) {
    let item = document.createElement('div');
    item.className = 'item';

    let number = document.createElement('div');
    number.id = 'ticket-number';
    number.innerHTML = ticket.number;
    item.appendChild(number);

    let name = document.createElement('div');
    name.className = 'artist';
    name.innerHTML = ticket.name;
    item.appendChild(name);

    let info = document.createElement('div');
    info.id = 'ticket-info';
    info.className = 'info';
    info.innerHTML = {'bars': "Bar", 'wc': "WC", 'stages': "Stage", 'activities': "Activity"}[ticket.type] + " | " + ("0" + Math.floor(ticket.estimatedTime/60000)).slice(-2) + ":" + ("0" + Math.round((ticket.estimatedTime%60000)/1000)).slice(-2);
    item.appendChild(info);

    let click = document.createElement('div');
    click.className = 'toggle';
    click.onclick = () => {
        loadTicketScreen(ticket);
        changeScreen('ticket');
    };
    item.appendChild(click);
    
    return item;
}

function loadTicketScreen(ticket) {
    document.getElementById('ticket-title').innerHTML = "[Ticket] " + ticket.name;
    if (document.getElementById('ticket-title').innerHTML.length > 15)
        document.getElementById('ticket-title').classList.add('slide');
    else
        document.getElementById('ticket-title').classList.remove('slide');

    document.getElementById('tickets-left').innerHTML = "Tickets left: " + ticket.number;
    document.getElementById('ewt').innerHTML = "Wait Time: " + ("0" + Math.floor(ticket.estimatedTime/60000)).slice(-2) + ":" + ("0" + Math.round((ticket.estimatedTime%60000)/1000)).slice(-2);

    document.getElementById('ticket-to-remove').innerHTML = ticket.name;
    currTicket = ticket;
}

function removeTicket() {
    tickets.splice(tickets.indexOf(currTicket), 1);
    loadPlaceScreen(getPlaceName(currTicket.name), currTicket.type);
}

function getPlaceName(name) {
    let placeOut;
    Object.keys(places).forEach((type) => {
        places[type].forEach((place) => {
            if (place.name === name)
                placeOut = place;
        });
    });
    if (placeOut)
        return placeOut;
    return false;
}